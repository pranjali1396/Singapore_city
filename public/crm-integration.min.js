/**
 * CRM Integration Script - Universal Version
 * Works for both Chouhan Park View and Chouhan Business Center websites
 * 
 * This script automatically detects which website it's on and configures itself accordingly.
 * 
 * Instructions:
 * 1. Update API_URL below with your backend URL
 * 2. Add this script to your website layout.js or _app.js (Next.js) or before </body> tag
 * 3. The script will automatically detect and handle form submissions
 * 
 * Supported Websites:
 * - Chouhan Park View (chouhan-park-view-xi.vercel.app)
 * - Chouhan Business Center (chouhan-business-center.vercel.app)
 */

(function () {
  'use strict';

  // ===== CONFIGURATION - UPDATE THIS =====
  const CONFIG = {
    // âš ï¸ IMPORTANT: This is your BACKEND API URL, NOT your website URL!
    // 
    // Staging backend (Render):
    API_URL: 'https://chouhan-crm-backend-staging.onrender.com/api/v1/webhooks/lead',
    //
    // For local testing (backend on your computer):
    // API_URL: 'http://localhost:5000/api/v1/webhooks/lead',
    //
    // For production (after deploying backend to Render):
    // API_URL: 'https://chouhan-crm-backend.onrender.com/api/v1/webhooks/lead',

    DEBUG: true // Set to false in production
  };

  // Auto-detect website and configure accordingly
  function getWebsiteConfig() {
    const hostname = window.location.hostname;
    const pathname = window.location.pathname;
    const pageTitle = document.title || '';

    // Detect Singapore City website by checking multiple sources
    const isSingaporeCity =
      hostname.includes('singapore') ||
      hostname.includes('singapore-city') ||
      pageTitle.toLowerCase().includes('singapore life city') ||
      pageTitle.toLowerCase().includes('singapore city');

    if (isSingaporeCity) {
      return {
        SOURCE_NAME: 'Singapore Life City Website',
        PROJECT_NAME: 'Singapore Life City',
        DEFAULT_CITY: 'Bhilai',
        DEFAULT_UNIT: 'Plot'
      };
    }

    // Detect Business Center website by checking multiple sources
    const isBusinessCenter =
      hostname.includes('business-center') ||
      hostname.includes('chouhan-business-center') ||
      pageTitle.toLowerCase().includes('business center') ||
      pageTitle.toLowerCase().includes('business centre');

    if (isBusinessCenter) {
      return {
        SOURCE_NAME: 'Chouhan Business Center Website',
        PROJECT_NAME: 'Chouhan Business Center',
        DEFAULT_CITY: 'Bhilai',
        DEFAULT_UNIT: 'Commercial'
      };
    }

    // Default to Park View
    return {
      SOURCE_NAME: 'Chouhan Park View Website',
      PROJECT_NAME: 'Chouhan Park View',
      DEFAULT_CITY: 'Bhilai',
      DEFAULT_UNIT: 'Flat'
    };
  }

  const WEBSITE_CONFIG = getWebsiteConfig();

  function log(msg, data) {
    if (CONFIG.DEBUG) console.log('[CRM]', msg, data || '');
  }

  function getUrlParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name) || '';
  }

  // Enhanced field detection - tries multiple variations
  function getFormField(formData, form, ...fieldNames) {
    // First try FormData
    for (const name of fieldNames) {
      if (formData.has(name)) {
        return formData.get(name);
      }
    }

    // Then try direct form element lookup (for React/Next.js forms)
    if (form) {
      for (const name of fieldNames) {
        const element = form.querySelector(`[name="${name}"]`) ||
          form.querySelector(`[id="${name}"]`) ||
          form.querySelector(`input[name="${name}"]`) ||
          form.querySelector(`textarea[name="${name}"]`) ||
          form.querySelector(`select[name="${name}"]`);
        if (element && element.value) {
          return element.value;
        }
      }
    }

    return '';
  }

  function mapFormToLead(formData, form) {
    // Try multiple field name variations
    const firstName = getFormField(formData, form, 'firstName', 'first_name', 'FirstName');
    const lastName = getFormField(formData, form, 'lastName', 'last_name', 'LastName');
    const name = getFormField(formData, form, 'name', 'Name', 'customerName', 'fullName', 'full_name', 'customer_name');
    const email = getFormField(formData, form, 'email', 'Email', 'emailAddress', 'email_address');
    const phone = getFormField(formData, form, 'phone', 'Phone', 'mobile', 'telephone', 'tel', 'contact', 'contactNumber', 'contact_number');
    const broker = getFormField(formData, form, 'broker', 'Are you a broker?', 'isBroker', 'is_broker');
    const source = getFormField(formData, form, 'source', 'How did you hear about us?', 'referralSource', 'referral_source', 'leadSource', 'lead_source');
    const homeType = getFormField(formData, form, 'homeType', 'Home type interested in?', 'home_type', 'propertyType', 'property_type', 'unitType', 'unit_type');
    const message = getFormField(formData, form, 'message', 'Message', 'remarks', 'comment', 'comments', 'description', 'query');
    const city = getFormField(formData, form, 'city', 'City', 'location');
    const phase = getFormField(formData, form, 'phase', 'Phase', 'phaseOfInterest', 'phase_of_interest');

    // Combine firstName and lastName if name is not provided
    const fullName = name || (firstName && lastName ? `${firstName} ${lastName}`.trim() : firstName || lastName || '');

    const unitMap = {
      '1 Bedroom': 'Flat', '2 Bedroom': 'Flat', '3 Bedroom': 'Flat', '4 Bedroom': 'Flat',
      'Flat': 'Flat', 'Bungalow': 'Bungalow', 'Commercial': 'Commercial',
      'Office': 'Commercial', 'Shop': 'Commercial', 'Warehouse': 'Commercial',
      'Plot': 'Plot'
    };
    const interestedUnit = unitMap[homeType] || homeType || WEBSITE_CONFIG.DEFAULT_UNIT;

    const enquiryMap = {
      'Google Search': 'Digital', 'Social Media': 'Digital', 'Newspaper': 'Digital',
      'Friend/Referral': 'Reference', 'Advertisement': 'Digital', 'Other': 'Digital',
      'Website': 'Digital', 'Online': 'Digital', 'Search Engine': 'Digital'
    };
    const modeOfEnquiry = enquiryMap[source] || 'Digital';

    return {
      source: WEBSITE_CONFIG.SOURCE_NAME,
      sourceUrl: window.location.origin + window.location.pathname,
      customerName: fullName.trim(),
      mobile: phone.trim(),
      email: email.trim(),
      city: city.trim() || WEBSITE_CONFIG.DEFAULT_CITY,
      interestedProject: WEBSITE_CONFIG.PROJECT_NAME,
      interestedUnit: interestedUnit,
      modeOfEnquiry: modeOfEnquiry,
      remarks: message.trim() || `Inquiry from ${WEBSITE_CONFIG.SOURCE_NAME}. Phase: ${phase || 'Not specified'}. Source: ${source || 'Unknown'}. Property type: ${homeType || 'Not specified'}. Broker: ${broker || 'Not specified'}`,
      metadata: {
        utm_source: getUrlParam('utm_source'),
        utm_campaign: getUrlParam('utm_campaign'),
        utm_medium: getUrlParam('utm_medium'),
        page_url: window.location.href,
        referrer: document.referrer,
        is_broker: broker === 'Yes' || broker === 'yes' || broker === 'true',
        lead_source: source || 'Unknown',
        home_type: homeType || 'Not specified',
        phase: phase || 'Not specified',
        timestamp: new Date().toISOString()
      }
    };
  }

  async function sendToCRM(leadData) {
    try {
      log('Sending lead...', leadData);
      const response = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(leadData)
      });
      const result = await response.json();
      if (response.ok && result.success) {
        log('âœ… Lead sent!', result.leadId);
        return { success: true, leadId: result.leadId };
      } else {
        log('âŒ Error:', result.error);
        return { success: false, error: result.error };
      }
    } catch (error) {
      log('âŒ Network error:', error);
      return { success: false, error: error.message };
    }
  }

  function init() {
    log('ðŸš€ CRM Integration initialized for:', WEBSITE_CONFIG.SOURCE_NAME);
    log('API URL:', CONFIG.API_URL);

    function detectAndSetupForms() {
      const forms = document.querySelectorAll('form');
      log(`Found ${forms.length} form(s) on page`);

      if (forms.length === 0) {
        log('âš ï¸ No forms found. Retrying in 1 second...');
        setTimeout(detectAndSetupForms, 1000);
        return;
      }

      forms.forEach((form, index) => {
        // Check if already set up
        if (form.dataset.crmSetup === 'true') {
          return;
        }

        form.dataset.crmSetup = 'true';
        log(`Setting up form ${index + 1}`);

        // Standard form submit event
        form.addEventListener('submit', async function (e) {
          await handleFormSubmit(e, form);
        }, true);

        // Also listen for submit button clicks (for React forms)
        const submitButton = form.querySelector('button[type="submit"]') ||
          form.querySelector('input[type="submit"]') ||
          form.querySelector('button:not([type])');

        if (submitButton) {
          submitButton.addEventListener('click', async function (e) {
            setTimeout(() => {
              handleFormSubmit(e, form);
            }, 100);
          }, true);
        }

        // Log form fields for debugging
        const inputs = form.querySelectorAll('input, textarea, select');
        log(`Form ${index + 1} has ${inputs.length} fields`);
        if (CONFIG.DEBUG) {
          inputs.forEach(input => {
            log(`  - ${input.name || input.id || 'unnamed'}: ${input.type || 'text'}`);
          });
        }
      });
    }

    async function handleFormSubmit(e, form) {
      try {
        const formData = new FormData(form);

        // Enhanced field detection
        const hasName = formData.has('name') || formData.has('Name') || formData.has('customerName') ||
          form.querySelector('[name="name"]') || form.querySelector('[name="Name"]');
        const hasPhone = formData.has('phone') || formData.has('Phone') || formData.has('mobile') ||
          form.querySelector('[name="phone"]') || form.querySelector('[name="Phone"]');
        const hasEmail = formData.has('email') || formData.has('Email') ||
          form.querySelector('[name="email"]') || form.querySelector('[name="Email"]');

        log('Form detection:', { hasName, hasPhone, hasEmail });

        if (hasName || hasPhone || hasEmail) {
          log('âœ… Contact form detected!');
          const leadData = mapFormToLead(formData, form);

          if (!leadData.customerName && !leadData.mobile) {
            log('âš ï¸ Warning: No name or phone found');
          }

          sendToCRM(leadData).then(result => {
            if (result.success) {
              log('âœ… Lead sent to CRM successfully!', result.leadId);
            } else {
              log('âŒ Failed to send lead:', result.error);
            }
          }).catch(err => log('âŒ Error:', err));
        } else {
          log('âš ï¸ Form does not appear to be a contact form');
        }
      } catch (error) {
        log('âŒ Error handling form:', error);
      }
    }

    // Wait for DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', detectAndSetupForms);
    } else {
      detectAndSetupForms();
    }

    // Listen for dynamically added forms (for React/Next.js)
    const observer = new MutationObserver(() => {
      detectAndSetupForms();
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.sendLeadToCRM = function (formData) {
    const leadData = mapFormToLead(formData);
    return sendToCRM(leadData);
  };

})();

